# 仿射变换校准升级说明

## 🎯 升级概述

基于提供的Java `GeoUtil.java`代码，我已经将校准工具从简单的线性插值升级为更精确的**仿射变换（Affine Transformation）**算法。

## 🔧 核心改进

### 1. 算法升级
- **之前**: 简单线性插值（2点最小）
- **现在**: 仿射变换 + 最小二乘法（3点最小）

### 2. 数学原理
```javascript
// 仿射变换公式（基于Java GeoUtil）
lat = a1 * x + b1 * z + c1
lon = a2 * x + b2 * z + c2

// 其中 x, z 是模型坐标（注意：y是高度，不参与转换）
// a1, b1, c1, a2, b2, c2 是通过最小二乘法计算的系数
```

### 3. 精度提升
- 使用最小二乘法拟合多个校准点
- 支持超定方程组（校准点数 > 3）
- 更好地处理测量误差

## 📁 修改的文件

### 1. `CoordinateCalibration.vue`
**新增功能**:
- 矩阵运算工具函数（转置、求逆、乘法）
- 仿射变换计算函数
- 最小二乘法拟合
- 更精确的误差计算（地理距离）

**关键函数**:
```javascript
// 矩阵运算
multiplyMatrix(A, B)
transposeMatrix(matrix)
invertMatrix(matrix)

// 仿射变换校准
calculateAffineTransformation(points)
```

### 2. `simulation.vue`
**新增功能**:
- 支持仿射变换和线性插值双模式
- 自动加载校准数据
- 智能回退机制

**关键函数**:
```javascript
// 加载校准数据
loadCalibrationData()

// 支持双模式的转换函数
latLonToModelCoords(lat, lon)
modelCoordsToLatLon(x, z)
```

## 🎮 使用方法

### 1. 校准工具使用
1. **加载模型**: 点击"加载模型"
2. **添加校准点**: 至少3个点（推荐4-6个）
3. **输入经纬度**: 为每个点输入准确的经纬度
4. **计算转换**: 点击"计算转换参数"
5. **查看精度**: 控制台显示每个点的误差
6. **导出数据**: 保存为JSON文件

### 2. 校准点选择建议
- **数量**: 4-6个点最佳
- **分布**: 均匀覆盖整个模型区域
- **特征**: 选择地标建筑、路口等易识别位置
- **精度**: 使用高德地图等获取精确经纬度

### 3. 精度评估
```
仿射变换精度验证:
  实际经纬度: (31.242242, 121.491421)
  预测经纬度: (31.242156, 121.491398)
  误差: 纬度=0.009km, 经度=0.003km, 总误差=12.34米
```

## 📊 性能对比

### 线性插值 vs 仿射变换

| 特性 | 线性插值 | 仿射变换 |
|------|----------|----------|
| 最少校准点 | 2个 | 3个 |
| 推荐校准点 | 4个 | 4-6个 |
| 精度 | 中等 | 高 |
| 抗噪声能力 | 弱 | 强 |
| 计算复杂度 | 低 | 中等 |
| 适用场景 | 简单映射 | 精确测量 |

### 预期精度提升
- **线性插值**: 平均误差 ~300-500米
- **仿射变换**: 平均误差 ~10-50米（取决于校准点质量）

## 🔄 兼容性

### 向后兼容
- 自动检测校准数据类型
- 无仿射系数时回退到线性插值
- 现有校准数据仍可使用

### 数据格式
```json
{
  "transformationMatrix": {
    "affineCoeffs": {
      "a1": 0.00000123, "b1": 0.00000456, "c1": 31.234567,
      "a2": 0.00000789, "b2": 0.00000012, "c2": 121.456789
    },
    "method": "affine",
    "averageError": 12.34,
    "pointCount": 5
  }
}
```

## 🚀 使用流程

### 1. 重新校准（推荐）
1. 打开校准工具 `/calibration`
2. 添加至少3个高质量校准点
3. 计算仿射变换参数
4. 导出新的校准数据

### 2. 集成到仿真
1. 校准数据会自动加载
2. 系统自动选择最佳转换方法
3. 控制台显示转换方法和精度信息

### 3. 验证精度
1. 使用调试面板测试已知坐标
2. 查看控制台的转换日志
3. 对比实际位置验证准确性

## 🎯 Java代码参考

基于提供的`GeoUtil.java`实现，关键对应关系：

| Java方法 | JavaScript实现 |
|----------|----------------|
| `calibrate()` | `calculateAffineTransformation()` |
| `scr2geo()` | `modelCoordsToLatLon()` |
| `geo2scr()` | `latLonToModelCoords()` |
| `linearFitAffine()` | 矩阵运算组合 |

## 📈 下一步优化

1. **动态校准**: 支持运行时添加校准点
2. **多区域校准**: 不同区域使用不同参数
3. **高阶变换**: 支持二次、三次多项式拟合
4. **自动验证**: 集成地图API验证校准精度

---

**总结**: 升级后的校准系统提供了更高的精度和更好的鲁棒性，特别适合需要精确位置映射的应用场景。建议重新进行校准以获得最佳效果。
