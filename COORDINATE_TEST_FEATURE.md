# 校准界面坐标转换测试功能

## 🎯 功能概述

在校准界面中新增了一个**坐标转换测试工具**，可以：
1. 加载已有的校准文件
2. 输入经纬度坐标
3. 输出对应的模型坐标和热力图坐标
4. 进行反向验证和误差分析

## 🔧 功能特性

### 1. 校准文件加载
- **支持格式**: JSON格式的校准文件
- **自动验证**: 检查文件格式和仿射变换系数
- **信息显示**: 显示校准点数量和平均误差

### 2. 坐标转换测试
- **输入**: 纬度和经度（支持6位小数精度）
- **输出**: 
  - 模型坐标 (X, Y, Z)
  - 热力图坐标 (x, y)
  - 反向验证结果
  - 转换误差（米）
  - 是否在校准范围内

### 3. 精度验证
- **反向转换**: 模型坐标 → 经纬度，验证转换精度
- **误差计算**: 使用地理距离公式计算实际误差
- **范围检查**: 标识坐标是否在校准范围内

## 🎮 使用方法

### 步骤1: 加载校准文件
1. 点击"加载校准文件"按钮
2. 选择之前导出的校准JSON文件
3. 系统会显示校准信息（点数、误差、方法）

### 步骤2: 输入测试坐标
1. 在"纬度"输入框输入纬度值（如：31.240000）
2. 在"经度"输入框输入经度值（如：121.490000）
3. 点击"转换"按钮

### 步骤3: 查看转换结果
系统会显示详细的转换结果：
- **输入经纬度**: 你输入的原始坐标
- **模型坐标**: 转换后的3D模型坐标
- **热力图坐标**: 对应的热力图像素坐标
- **在校准范围内**: 是否在校准点覆盖范围内
- **反向验证**: 反向转换的经纬度结果
- **转换误差**: 转换精度（米）

## 📊 界面布局

```
┌─────────────────────────────────────┐
│ 坐标转换测试                        │
│ ┌─────────────────┐ [加载校准文件]   │
├─────────────────────────────────────┤
│ 已加载校准: 6个校准点，平均误差2.70米 │
│ 校准方法: 仿射变换                   │
├─────────────────────────────────────┤
│ 纬度: [31.240000] 经度: [121.490000] │
│                           [转换]     │
├─────────────────────────────────────┤
│ 转换结果:                           │
│ ├ 输入经纬度: (31.240000, 121.490000)│
│ ├ 模型坐标: (X: -72.40, Y: 0, Z: 812.98)│
│ ├ 热力图坐标: (95, 224)              │
│ ├ 在校准范围内: 是                   │
│ ├ 反向验证: 纬度31.240001, 经度121.489999│
│ └ 转换误差: 1.23米                   │
└─────────────────────────────────────┘
```

## 🔍 测试示例

### 示例1: 校准范围内的坐标
```
输入: 纬度31.240000, 经度121.490000
输出: 
- 模型坐标: (X: -72.40, Y: 0, Z: 812.98)
- 热力图坐标: (95, 224)
- 在校准范围内: 是
- 转换误差: 1.23米
```

### 示例2: 校准范围外的坐标
```
输入: 纬度31.250000, 经度121.500000
输出:
- 模型坐标: (X: 150.23, Y: 0, Z: 950.45)
- 热力图坐标: (320, -50)
- 在校准范围内: 否（使用外推）
- 转换误差: 15.67米
```

## ⚠️ 注意事项

### 1. 校准文件要求
- 必须是通过校准工具导出的JSON文件
- 必须包含仿射变换系数
- 建议使用最新的校准数据

### 2. 精度说明
- **校准范围内**: 精度较高，通常误差<10米
- **校准范围外**: 使用线性外推，精度可能降低
- **误差来源**: 校准点精度、仿射变换拟合误差

### 3. 坐标系说明
- **模型坐标**: 3D模型中的坐标系（Y轴为高度）
- **热力图坐标**: 2D热力图的像素坐标（Y轴已翻转）
- **经纬度**: WGS84地理坐标系

## 🎯 应用场景

### 1. 校准验证
- 验证校准精度
- 测试已知地标的转换结果
- 对比不同校准方法的效果

### 2. 数据调试
- 调试热力图数据显示问题
- 验证坐标转换逻辑
- 分析转换误差来源

### 3. 系统集成
- 测试API接口的坐标转换
- 验证前后端坐标一致性
- 调试地图显示问题

## 🔧 技术实现

### 核心算法
```javascript
// 仿射变换逆运算：经纬度 -> 模型坐标
function convertLatLonToModel(lat, lon) {
  const coeffs = loadedCalibration.affineCoeffs
  const det = coeffs.a1 * coeffs.b2 - coeffs.a2 * coeffs.b1
  
  const latDiff = lat - coeffs.c1
  const lonDiff = lon - coeffs.c2
  const x = (latDiff * coeffs.b2 - lonDiff * coeffs.b1) / det
  const z = (lonDiff * coeffs.a1 - latDiff * coeffs.a2) / det
  
  return { x, y: 0, z }
}
```

### 误差计算
```javascript
// 地理距离误差计算
const latError = Math.abs(predicted.lat - actual.lat) * 111000 // 米
const lonError = Math.abs(predicted.lon - actual.lon) * 111000 * 
                 Math.cos(actual.lat * Math.PI / 180) // 米
const totalError = Math.sqrt(latError * latError + lonError * lonError)
```

## 📈 后续优化

1. **批量测试**: 支持CSV文件批量测试多个坐标
2. **可视化**: 在3D模型上显示测试点位置
3. **导出功能**: 导出测试结果为报告
4. **实时预览**: 输入坐标时实时显示转换结果

---

**使用建议**: 建议在每次重新校准后，使用几个已知地标坐标进行测试验证，确保转换精度符合要求。
