# 坐标系映射诊断报告

## 🔍 问题分析

通过检查校准数据和转换逻辑，我发现了几个可能导致地图坐标系转换出错的问题：

## 📊 当前校准数据分析

### 校准点数据
```
校准点1: 模型(-72.40, 812.98) -> 经纬度(31.242242, 121.491427)
校准点2: 模型(106.20, 796.42) -> 经纬度(31.244036, 121.490378)
校准点3: 模型(-71.62, 411.38) -> 经纬度(31.240711, 121.486782)
校准点4: 模型(-3.91, 176.28) -> 经纬度(31.240478, 121.483794)
校准点5: 模型(-292.64, 403.93) -> 经纬度(31.238495, 121.487661)
校准点6: 模型(-288.37, 160.31) -> 经纬度(31.237553, 121.484886)
```

### 坐标范围
- **模型X范围**: -292.64 到 106.20 (约398.84单位)
- **模型Z范围**: 160.31 到 812.98 (约652.67单位)
- **经度范围**: 121.483794 到 121.491427 (约0.007633度)
- **纬度范围**: 31.237553 到 31.244036 (约0.006483度)

## 🚨 发现的问题

### 1. 仿射变换系数异常小
```javascript
affineCoeffs: {
  a1: 0.000010058368001095164,  // 极小的系数
  b1: 0.000003897104413334851,
  c1: 31.239836286743987,
  a2: -0.00000447792356275678,
  b2: 0.000011466107186733354,
  c2: 121.48174634639462
}
```

**问题**: 系数过小可能导致数值精度问题，特别是在JavaScript的浮点运算中。

### 2. 热力图Y轴方向问题
**原问题**: 没有考虑图像坐标系Y轴翻转
**修正**: 添加了Y轴翻转逻辑
```javascript
// 修正前
const y = ((modelZ - minZ) / (maxZ - minZ)) * canvasHeight

// 修正后  
const yNormalized = (modelZ - minZ) / (maxZ - minZ)
const y = canvasHeight - (yNormalized * canvasHeight) // Y轴翻转
```

### 3. 坐标轴映射关系不明确
从校准数据看，需要分析X/Z轴与经纬度的相关性：
- X轴变化 vs 经度变化
- Z轴变化 vs 纬度变化

## 🔧 已实施的修正

### 1. 添加相关性分析
```javascript
const calculateCorrelation = (x, y) => {
  // 计算皮尔逊相关系数
}
```

### 2. 增强调试信息
- 校准点数据分析
- 坐标范围分析  
- 相关性分析
- 变换矩阵行列式验证

### 3. 添加验证函数
- `validateAffineTransformation()`: 验证仿射变换精度
- `validateHeatmapTransformation()`: 验证热力图坐标转换

### 4. 修正热力图Y轴翻转
根据Java GeoUtil中的`y = imgH - y`逻辑，添加了Y轴翻转。

## 🎯 建议的解决方案

### 1. 重新校准（推荐）
使用改进的校准工具重新进行校准：
1. 确保校准点分布均匀
2. 使用高精度的经纬度坐标
3. 验证相关性分析结果
4. 检查仿射变换系数的合理性

### 2. 坐标轴映射验证
运行验证函数检查：
```javascript
// 在控制台查看
validateAffineTransformation()
validateHeatmapTransformation()
```

### 3. 数值精度优化
考虑使用更高精度的数值计算或坐标归一化。

## 📋 测试步骤

### 1. 打开浏览器控制台
页面加载时会自动运行验证函数

### 2. 查看验证结果
- 仿射变换精度（应该<10米误差）
- 热力图坐标映射是否合理
- 边界点是否正确映射

### 3. 测试实际数据
使用真实的经纬度数据测试转换结果

## 🔄 下一步行动

1. **立即**: 查看控制台验证结果
2. **短期**: 根据相关性分析调整坐标轴映射
3. **中期**: 重新校准获得更精确的参数
4. **长期**: 考虑更高阶的变换算法

## 📊 预期改进

修正后应该看到：
- 仿射变换误差 < 10米
- 热力图坐标正确映射到对应位置
- 边界点映射到热力图的正确角落
- 整体坐标转换精度显著提升

---

**注意**: 请运行页面并查看控制台输出，根据实际验证结果进一步调整参数。
